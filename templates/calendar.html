{% extends "base.html" %}

{% block title %}Kalender{% endblock %}

{% block head %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
{% endblock %}

{% block content %}
    <section class="page-hero">
        <div>
            <p class="eyebrow">Übersicht</p>
            <h1>Kalender</h1>
            <p class="subhead">Plane Termine und behalte automatisch erkannte Duschen im Blick.</p>
        </div>
    </section>

    <div class="modal-backdrop" id="eventModalBackdrop" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="eventModalTitle">
            <div class="modal-header">
                <h2 id="eventModalTitle">Termin hinzufügen</h2>
                <button type="button" class="modal-close" id="closeEventModal" aria-label="Schließen">&times;</button>
            </div>
            <div class="modal-body">
                <div class="control-field">
                    <label for="eventTitle">Titel</label>
                    <input type="text" id="eventTitle" placeholder="Neuer Termin">
                </div>
                <div class="control-field">
                    <label for="eventStart">Start</label>
                    <input type="datetime-local" id="eventStart">
                </div>
                <div class="control-field">
                    <label for="eventEnd">Ende</label>
                    <input type="datetime-local" id="eventEnd">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="button-secondary" id="deleteEventButton">Eintrag löschen</button>
                <button type="button" class="button-secondary" id="cancelEventButton">Abbrechen</button>
                <button type="button" id="saveEventButton">Eintrag speichern</button>
            </div>
        </div>
    </div>

    <section class="card calendar-card">
        <div id="calendar"></div>
    </section>
{% endblock %}

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script>
        function toDatetimeLocalValue(date) {
            if (!date) return '';
            const offset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() - offset).toISOString().slice(0, 16);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');
            const titleInput = document.getElementById('eventTitle');
            const startInput = document.getElementById('eventStart');
            const endInput = document.getElementById('eventEnd');
            const saveButton = document.getElementById('saveEventButton');
            const deleteButton = document.getElementById('deleteEventButton');
            const modalBackdrop = document.getElementById('eventModalBackdrop');
            const modalTitle = document.getElementById('eventModalTitle');
            const closeModalButton = document.getElementById('closeEventModal');
            const cancelModalButton = document.getElementById('cancelEventButton');
            let editingEventId = null;
            let editingEventType = null;
            deleteButton.style.display = 'none';

            function openModal() {
                modalBackdrop.classList.add('is-open');
                modalBackdrop.setAttribute('aria-hidden', 'false');
            }

            function closeModal() {
                modalBackdrop.classList.remove('is-open');
                modalBackdrop.setAttribute('aria-hidden', 'true');
            }

            function openNewEvent(date) {
                editingEventId = null;
                editingEventType = 'user';
                titleInput.value = '';
                titleInput.disabled = false;
                const startDate = new Date(date);
                const endDate = new Date(startDate.getTime() + 60 * 60 * 1000);
                startInput.value = toDatetimeLocalValue(startDate);
                endInput.value = toDatetimeLocalValue(endDate);
                modalTitle.textContent = 'Termin hinzufügen';
                saveButton.textContent = 'Eintrag speichern';
                deleteButton.style.display = 'none';
                openModal();
            }

            function openEditEvent(event) {
                editingEventId = event.id;
                editingEventType = event.extendedProps.type || 'user';
                titleInput.value = event.title || '';
                startInput.value = toDatetimeLocalValue(event.start);
                endInput.value = toDatetimeLocalValue(event.end);
                titleInput.disabled = editingEventType === 'shower';
                modalTitle.textContent = editingEventType === 'shower' ? 'Duschen bearbeiten' : 'Termin bearbeiten';
                saveButton.textContent = 'Eintrag aktualisieren';
                deleteButton.style.display = 'inline-flex';
                openModal();
            }

            const calendar = new FullCalendar.Calendar(calendarEl, {
                locale: 'de',
                initialView: 'dayGridMonth',
                navLinks: true,
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: '/calendar_events',
                dateClick: function(info) {
                    openNewEvent(info.date);
                },
                eventClick: function(info) {
                    if (!info.event.id) {
                        return;
                    }

                    openEditEvent(info.event);
                }
            });

            calendar.render();

            closeModalButton.addEventListener('click', closeModal);
            cancelModalButton.addEventListener('click', closeModal);
            modalBackdrop.addEventListener('click', function(event) {
                if (event.target === modalBackdrop) {
                    closeModal();
                }
            });

            saveButton.addEventListener('click', function() {
                const title = titleInput.value.trim();
                const startValue = startInput.value;
                const endValue = endInput.value;

                if ((!title && editingEventType !== 'shower') || !startValue) {
                    alert('Bitte Titel und Startzeit angeben.');
                    return;
                }

                const payload = {
                    start: startValue,
                    end: endValue || null
                };

                if (editingEventType !== 'shower') {
                    payload.title = title;
                }

                const url = editingEventId ? `/calendar_events/${editingEventId}` : '/calendar_events';
                const method = editingEventId ? 'PATCH' : 'POST';

                fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Fehler beim Speichern.');
                        }
                        return response.json();
                    })
                    .then(() => {
                        titleInput.value = '';
                        endInput.value = '';
                        editingEventId = null;
                        closeModal();
                        calendar.refetchEvents();
                    })
                    .catch(() => {
                        alert('Eintrag konnte nicht gespeichert werden.');
                    });
            });

            deleteButton.addEventListener('click', function() {
                if (!editingEventId) {
                    return;
                }

                fetch(`/calendar_events/${editingEventId}`, {
                    method: 'DELETE'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Fehler beim Löschen.');
                        }
                        return response.json();
                    })
                    .then(() => {
                        titleInput.value = '';
                        endInput.value = '';
                        editingEventId = null;
                        editingEventType = null;
                        closeModal();
                        calendar.refetchEvents();
                    })
                    .catch(() => {
                        alert('Eintrag konnte nicht gelöscht werden.');
                    });
            });
        });
    </script>
{% endblock %}
