{% extends "base.html" %}

{% block title %}Home{% endblock %}

{% block content %}
<div class="page-hero">
    <div>
        <p class="eyebrow">SmartHome</p>
        <h1>Kontrollzentrum</h1>
        <p class="subhead">Steuere deine Geräte, behalte die Räume im Blick und sieh sofort die letzten Messwerte.</p>
    </div>
</div>

<section class="card-grid weather-grid">
    {% for report in weather %}
    <article class="card weather-card">
        <div class="card-header">
            <div>
                <p class="eyebrow">Wetter</p>
                <h3>{{ report.location }}</h3>
            </div>
            {% if report.temperature is not none %}
                <span class="pill">Aktuell</span>
            {% else %}
                <span class="pill pill-error">Offline</span>
            {% endif %}
        </div>
        {% if report.error %}
            <p class="error-text">{{ report.error }}</p>
        {% else %}
            <div class="weather-values">
                <div>
                    <p class="label">Temperatur</p>
                    <p class="value">{% if report.temperature is not none %}{{ report.temperature | round(1) }}°C{% else %}—{% endif %}</p>
                </div>
                <div>
                    <p class="label">Luftfeuchte</p>
                    <p class="value">{% if report.humidity is not none %}{{ report.humidity }}%{% else %}—{% endif %}</p>
                </div>
            </div>
            <div class="forecast">
                <div>
                    <p class="label">Max</p>
                    <p class="value">{{ report.forecast_max | default('—') }}°C</p>
                </div>
                <div>
                    <p class="label">Min</p>
                    <p class="value">{{ report.forecast_min | default('—') }}°C</p>
                </div>
                <div>
                    <p class="label">Regen</p>
                    <p class="value">{{ report.precipitation_probability | default('—') }}%</p>
                </div>
            </div>
        {% endif %}
    </article>
    {% endfor %}
</section>

{% if has_devices %}
<section class="rooms">
    {% for room, devices in device_rooms.items() %}
        <article class="card room-card">
            <div class="card-header">
                <div>
                    <p class="eyebrow">Raum</p>
                    <h2>{{ room }}</h2>
                </div>
                <span class="pill">{{ devices|length }} Geräte</span>
            </div>
            <div class="device-grid">
                {% for device in devices %}
                    <div class="device-card" data-device="{{ device.id }}">
                        <div class="device-head">
                            <div>
                                <p class="eyebrow">{{ device.type | capitalize }}</p>
                                <h3>{{ device.name }}</h3>
                                <p class="muted">IP: {{ device.ip }}</p>
                            </div>
                            <span class="status-pill status-{{ device.status | default('unknown') | replace(' ', '-') }}">{{ device.status | default('unbekannt') }}</span>
                        </div>

                        {% if 'Temperature' in device.elements and device.reading %}
                            <div class="device-readings">
                                <div>
                                    <p class="label">Temperatur</p>
                                    <p class="value">{{ device.reading.temperature | round(1) }}°C</p>
                                </div>
                                <div>
                                    <p class="label">Luftfeuchte</p>
                                    <p class="value">{{ device.reading.humidity | round(1) }}%</p>
                                </div>
                                <p class="muted">Letztes Update: {{ device.reading.timestamp.strftime('%d.%m.%Y %H:%M') }}</p>
                            </div>
                        {% endif %}

                        <div class="control-group">
                            {% if 'Led' in device.elements %}
                                <div class="control-row">
                                    <p class="label">LED</p>
                                    <div class="button-row">
                                        <button onclick="sendCommand('{{ device.id }}', 'on')">An</button>
                                        <button onclick="sendCommand('{{ device.id }}', 'off')">Aus</button>
                                    </div>
                                </div>
                            {% endif %}

                            {% if 'Socket' in device.elements %}
                                <div class="control-row">
                                    <p class="label">Steckdose</p>
                                    <div class="button-row">
                                        <button onclick="sendSocketCommand('{{ device.id }}', 'on')">An</button>
                                        <button onclick="sendSocketCommand('{{ device.id }}', 'off')">Aus</button>
                                    </div>
                                </div>
                            {% endif %}
                        </div>

                        <div class="element-list">
                            {% for element in device.elements %}
                                <span class="pill pill-light">{{ element }}</span>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </article>
    {% endfor %}
</section>
{% else %}
    <p class="muted">Keine steuerbaren Geräte gefunden.</p>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    var socket = io.connect('http://' + document.domain + ':' + location.port);

    socket.on('connect', function() {
        socket.on('led_status', function(data) {
            var pill = document.querySelector('[data-device="' + data.device_id + '"] .status-pill');
            var statusText = data.status || 'unbekannt';
            var statusClass = statusText.toString().replace(/\s+/g, '-');
            if (pill) {
                pill.innerText = statusText;
                pill.className = 'status-pill status-' + statusClass;
            }
        });

        socket.on('socket_status', function(data) {
            var pill = document.querySelector('[data-device="' + data.device_id + '"] .status-pill');
            var statusText = data.status || 'unbekannt';
            var statusClass = statusText.toString().replace(/\s+/g, '-');
            if (pill) {
                pill.innerText = statusText;
                pill.className = 'status-pill status-' + statusClass;
            }
        });
    });

    function sendCommand(deviceId, command) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", '/control_led/' + deviceId, true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.send('command=' + command);
    }

    function sendSocketCommand(deviceId, command) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", '/control_socket/' + deviceId, true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.send('command=' + command);
    }
</script>
{% endblock %}
