{% extends "base.html" %}

{% block title %}Power Monitor{% endblock %}

{% block content %}
<section class="page-hero">
    <div>
        <p class="eyebrow">Energie</p>
        <h1>Power Monitor</h1>
        <p class="subhead">Überwache Spannung, Strom und Verbrauch deiner Steckdosen in Echtzeit.</p>
    </div>
</section>

<div class="card">
    <h2>Socket Power Monitor</h2>
    <p>Live dashboard for voltage, current, power, and cumulative energy from the Shelly socket.</p>
    <div class="temperature-controls">
        <div class="control-field">
            <label for="deviceSelector">Socket</label>
            <select id="deviceSelector"></select>
        </div>
        <div class="control-field">
            <label for="timeRange">Time window</label>
            <select id="timeRange">
                <option value="300">Last 5 minutes</option>
                <option value="900">Last 15 minutes</option>
                <option value="3600" selected>Last hour</option>
                <option value="86400">Last 24 hours</option>
            </select>
        </div>
        <div class="control-field">
            <label>&nbsp;</label>
            <button id="refreshButton">Load data</button>
        </div>
    </div>

    <div class="power-meta">
        <span>Samples in view:</span>
        <strong id="sampleCount">0</strong>
    </div>

    <div class="stat-grid power-stats">
        <div class="stat-card">
            <h3>Voltage</h3>
            <p id="voltageValue" class="stat-value">–</p>
        </div>
        <div class="stat-card">
            <h3>Current</h3>
            <p id="currentValue" class="stat-value">–</p>
        </div>
        <div class="stat-card highlight">
            <h3>Power</h3>
            <p id="powerValue" class="stat-value">–</p>
        </div>
        <div class="stat-card">
            <h3>Total Energy</h3>
            <p id="energyValue" class="stat-value">–</p>
        </div>
    </div>

    <canvas id="powerChart" style="width:100%; max-height:420px;"></canvas>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/moment@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
<script>
    const socket = io();
    const chartCtx = document.getElementById('powerChart').getContext('2d');
    let powerChart;
    let samples = [];
    let selectedDeviceId = null;
    let availableDevices = [];

    function buildChart() {
        powerChart = new Chart(chartCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Power (W)',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.3)',
                        yAxisID: 'power',
                    },
                    {
                        label: 'Voltage (V)',
                        data: [],
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.3)',
                        yAxisID: 'voltage',
                    },
                    {
                        label: 'Current (A)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.25)',
                        yAxisID: 'current',
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                interaction: {
                    intersect: false,
                    mode: 'index',
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            tooltipFormat: 'MMM D, YYYY, h:mm:ss a',
                        },
                    },
                    power: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: 'Watts' },
                    },
                    voltage: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: 'Volts' },
                        grid: { drawOnChartArea: false },
                    },
                    current: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: 'Amps' },
                        grid: { drawOnChartArea: false },
                        min: 0,
                    },
                },
                plugins: {
                    zoom: {
                        zoom: {
                            wheel: { enabled: true },
                            pinch: { enabled: true },
                            mode: 'x',
                        },
                        pan: { enabled: true, mode: 'x' },
                    },
                },
            },
        });
    }

    function updateStats(latest) {
        if (!latest) return;
        document.getElementById('voltageValue').textContent = latest.voltage !== null ? `${latest.voltage.toFixed(1)} V` : '–';
        document.getElementById('currentValue').textContent = latest.current !== null ? `${latest.current.toFixed(3)} A` : '–';
        document.getElementById('powerValue').textContent = latest.power !== null ? `${latest.power.toFixed(1)} W` : '–';
        document.getElementById('energyValue').textContent = latest.energy !== null ? `${latest.energy.toFixed(1)} Wh` : '–';
    }

    function trimSamples(durationSeconds) {
        const cutoff = moment().subtract(durationSeconds, 'seconds');
        samples = samples.filter(sample => moment(sample.timestamp).isAfter(cutoff));
    }

    function renderChart() {
        if (!powerChart) return;
        powerChart.data.labels = samples.map(sample => sample.timestamp);
        powerChart.data.datasets[0].data = samples.map(sample => sample.power);
        powerChart.data.datasets[1].data = samples.map(sample => sample.voltage);
        powerChart.data.datasets[2].data = samples.map(sample => sample.current);
        powerChart.update();
    }

    async function fetchHistoricalData() {
        const durationSeconds = parseInt(document.getElementById('timeRange').value, 10);

        const response = await fetch(`/get_power_data?duration_seconds=${durationSeconds}&device_id=${selectedDeviceId}`);
        const data = await response.json();

        samples = data.map(sample => ({ ...sample, timestamp: new Date(sample.timestamp) }));
        trimSamples(durationSeconds);
        document.getElementById('sampleCount').textContent = samples.length.toLocaleString();
        renderChart();
        updateStats(samples[samples.length - 1]);
    }

    async function loadDevices() {
        const response = await fetch('/get_power_devices');
        availableDevices = await response.json();
        const selector = document.getElementById('deviceSelector');
        selector.innerHTML = '';
        availableDevices.forEach((device) => {
            const option = document.createElement('option');
            option.value = device.id;
            option.textContent = device.name;
            selector.appendChild(option);
        });

        if (!selectedDeviceId && availableDevices.length > 0) {
            selectedDeviceId = availableDevices[0].id;
        }
        selector.value = selectedDeviceId;
    }

    document.getElementById('refreshButton').addEventListener('click', fetchHistoricalData);
    document.getElementById('timeRange').addEventListener('change', fetchHistoricalData);
    document.getElementById('deviceSelector').addEventListener('change', (event) => {
        selectedDeviceId = event.target.value;
        samples = [];
        document.getElementById('sampleCount').textContent = '0';
        fetchHistoricalData();
    });

    socket.on('power_sample', sample => {
        console.log("Selected:", selectedDeviceId, "Sample:", sample);
        if (sample.device_id === selectedDeviceId) {
            const normalized = { ...sample, timestamp: new Date(sample.timestamp) };
            updateStats(normalized);
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        buildChart();
        loadDevices().then(() => {
            fetchHistoricalData();
        });
    });
</script>
{% endblock %}
