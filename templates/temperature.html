{% extends "base.html" %}

{% block title %}Temperatur Historie{% endblock %}

{% block content %}

    <section class="page-hero">
        <div>
            <p class="eyebrow">Verlauf</p>
            <h1>Temperatur Historie</h1>
            <p class="subhead">Live-Auswertung für Temperatur und Feuchte im direkten Vergleich.</p>
        </div>
    </section>

    <section class="card temperature-controls">
        <div class="control-field">
            <label for="deviceSelect">Gerät auswählen</label>
            <select id="deviceSelect" onchange="updateChartForSelectedDevice()">
                <!-- Dynamisch per JS befüllt -->
            </select>
        </div>
        <div class="control-field">
            <label for="selectedDate">Datum filtern</label>
            <div class="control-inline">
                <input type="date" id="selectedDate">
                <button onclick="loadDataForSelectedDate()">Daten laden</button>
            </div>
        </div>
    </section>

    <section class="temperature-grid">
        <div class="card chart-card">
            <div class="card-header">
                <div>
                    <h2>Temperatur</h2>
                    <p class="muted">In °C</p>
                </div>
                <span class="pill">Live</span>
            </div>
            <canvas id="temperatureChart"></canvas>
        </div>
        <div class="card chart-card">
            <div class="card-header">
                <div>
                    <h2>Feuchte</h2>
                    <p class="muted">In %</p>
                </div>
                <span class="pill pill-light">Live</span>
            </div>
            <canvas id="humidityChart"></canvas>
        </div>
    </section>

{% endblock %}

{% block scripts %}
    <script>
        let globalData = [];  // Global variable to store all temperature data


        const temperatureCtx = document.getElementById('temperatureChart').getContext('2d');
        const humidityCtx = document.getElementById('humidityChart').getContext('2d');

        const baseChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'hour',
                        tooltipFormat: 'MMM D, YYYY, h:mm a'
                    }
                }
            },
            plugins: {
                zoom: {
                    pan: {
                        enabled: true,
                        mode: 'xy',
                        threshold: 10
                    },
                    zoom: {
                        wheel: {
                            enabled: true
                        },
                        pinch: {
                            enabled: true
                        },
                        mode: 'xy'
                    }
                }
            }
        };

        const temperatureChart = new Chart(temperatureCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Temperatur (°C)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgb(255, 99, 132)',
                    data: [],
                    tension: 0.3,
                    fill: true
                }]
            },
            options: baseChartOptions
        });

        const humidityChart = new Chart(humidityCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Feuchte (%)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgb(54, 162, 235)',
                    data: [],
                    tension: 0.3,
                    fill: true
                }]
            },
            options: baseChartOptions
        });


        function loadAvailableDevices() {
            fetch('/get_available_devices')
                .then(response => response.json())
                .then(devices => {
                    const deviceSelect = document.getElementById('deviceSelect');
                    deviceSelect.innerHTML = ''; // Clear existing options

                    devices.forEach(deviceId => {
                        const option = document.createElement('option');
                        option.value = deviceId;
                        option.textContent = deviceId;
                        deviceSelect.appendChild(option);
                    });

                    // Lade das Chart mit dem ersten Gerät
                    if (devices.length > 0) {
                        updateChartForSelectedDevice();
                    }
                });
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadAvailableDevices();
        });

        function updateChartWithData(filteredData) {
            const temperatureData = filteredData.map(record => record.temperature);
            const humidityData = filteredData.map(record => record.humidity);
            const labels = filteredData.map(record => moment(record.timestamp).format('YYYY-MM-DD HH:mm:ss'));

            temperatureChart.data.labels = labels;
            temperatureChart.data.datasets[0].data = temperatureData;
            temperatureChart.update();

            humidityChart.data.labels = labels;
            humidityChart.data.datasets[0].data = humidityData;
            humidityChart.update();
        }

        function updateChartForDate(selectedDate) {
            let filteredData;
            if (selectedDate) {
                const startDate = moment(selectedDate).startOf('day');
                const endDate = moment(selectedDate).endOf('day');
                filteredData = globalData.filter(record => moment(record.timestamp).isBetween(startDate, endDate));
            } else {
                let now = moment();
		//console.log("Current time (now): ", now.format());

		filteredData = globalData.filter(record => {
		    let recordTime = moment(record.timestamp);
		    //console.log("Record time: ", recordTime.format(), " | Is after 24 hours ago? ", recordTime.isAfter(now.clone().subtract(24, 'hours')));
		    return recordTime.isAfter(now.clone().subtract(24, 'hours'));
		});
            }
	    //console.log(filteredData); // Debugging line
            updateChartWithData(filteredData);
        }
	

	function updateChartForSelectedDevice() {

	    const selectedDevice = document.getElementById('deviceSelect').value;

	    const selectedDateValue = document.getElementById('selectedDate').value;



	    fetch(`/get_temperature_data?device_id=${selectedDevice}&date=${selectedDateValue || ''}`)

		.then(response => response.json())

		.then(data => {

		    globalData = data;

		    updateChartWithData(globalData);

		});

	}

	function loadDataForSelectedDate() {

	    updateChartForSelectedDevice();

	}

        document.addEventListener('DOMContentLoaded', function() {
		updateChartForSelectedDevice(); // Load data for the default selected device on page load
        });

        // Initialize chart with empty data
        

    </script>
{% endblock %}
